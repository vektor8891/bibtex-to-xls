#!/usr/bin/env python3

import subprocess
import tkinter.messagebox as m
import bibtexparser
import pandas as pd

# save list of books
file_path = "/home/vszabo/Dropbox/Backup_shared/konyvek.bib"
with open(file_path) as bibtex_file:
    bib_database = bibtexparser.load(bibtex_file)
df = pd.DataFrame(bib_database.entries)
books = df[['author', 'title', 'year', 'isbn', 'url']]
books_sorted = books.sort_values(by=['author', 'title'])
books_sorted.to_excel("/home/vszabo/Dropbox/Backup_shared/konyvek.xls", index=False, engine='xlsxwriter')
books_sorted.to_csv("/home/vszabo/Git/notes/_data/books.csv", index=False)

# update repo
folder_path = "/home/vszabo/PycharmProjects/bibtex-to-xls/"
remote_name = 'origin'
branch_name = 'main'
subprocess.run(['git', 'fetch', remote_name], cwd=folder_path, check=True)
local_commit = subprocess.run(['git', 'rev-parse', branch_name], cwd=folder_path,
                              stdout=subprocess.PIPE, text=True, check=True).stdout.strip()
remote_commit = subprocess.run(['git', 'rev-parse', f'{remote_name}/{branch_name}'],
                               cwd=folder_path, stdout=subprocess.PIPE, text=True, check=True).stdout.strip()
if local_commit != remote_commit:
    subprocess.run(['git', 'add', '.'], cwd=folder_path, check=True)
    subprocess.run(['git', 'commit', '-m', 'update books'], cwd=folder_path, check=True)
    subprocess.run(['git', 'push'], cwd=folder_path, check=True)
m.showinfo("Alert", "List of books updated successfully.")
